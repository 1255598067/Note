# TCP三次握手和四次挥手

建立TCP链接是为了保证稳定有序的收发数据，那么就要保证双方的`发送能力`和`接收能力`都是OK的。 

## 三次握手

三次握手之所以三次，是保证`client`和`server`都让 **"对方"** 知道自己发送和接收能力都OK的最小次数。

> `client => server` server判断出client具备发送能力
>
> `server => client` client可以判断出server具备发送和接受能力
>
> `client => server` client还需让server知道自己接收能力没问题,

- 客户端：我准备好了，你准备好了么，收到请回答？ 
- 服务端：我收到了，我也准备好了，你收到了么？ 
- 客户端：我也收到了

双方均保证了自己的接收和发送能力没有问题

TCP连接建立，两次无法保证，四次会多余，三次刚刚好。

![](./../img/http1.jpg)

从最开始双方都处于`CLOSED`状态。然后服务端开始监听某个端口，进入了`LISTEN`状态。

- 第一次握手

客户端主动发起连接，发送 SYN , 发送完毕后，客户端进入`SYN-SENT`状态。

- 第二次握手

服务端接收到，返回SYN和ACK(对应客户端发来的SYN)，发送完毕后，服务器端进入`SYN_RCVD`状态。

- 第三次握手

客户端再发送ACK给服务端，发送完毕后，客户端进入`ESTABLISHED`状态；服务端收到ACK之后，也进入`ESTABLISHED`状态，TCP 握手结束。

## 四次挥手

![](./../img/http2.jpg)

刚开始双方处于`ESTABLISHED`状态。

- 第一次挥手

客户端想要关闭连接，向服务器发送 FIN 报文，发送完毕后，客户端进入`FIN_WAIT_1`状态。

注意, 这时候客户端同时也变成了`half-close(半关闭)`状态，即无法向服务端发送报文，只能接收。

- 第二次挥手

服务器端确认客户端的 FIN 包，发送一个确认包，表明自己接受到了客户端关闭连接的请求，但还没有准备好关闭连接。

发送完毕后，服务器端进入`CLOSED_WAIT`状态，客户端接收到这个确认包之后，进入`FIN_WAIT_2`状态，等待服务器端关闭连接。

- 第三次挥手

服务器端准备好关闭连接时，向客户端发送结束连接请求，FIN 置为1。

发送完毕后，服务器端进入`LAST_ACK`状态，等待来自客户端的最后一个ACK。

- 第四次挥手

客户端接收到来自服务器端的关闭请求，发送一个确认包，并进入`TIME_WAIT`状态，等待可能出现的要求重传的 ACK 包。

服务器端接收到这个确认包之后，关闭连接，进入`CLOSED`状态。

客户端等待了某个固定时间（两个最大段生命周期，2MSL，2 Maximum Segment Lifetime）之后，没有收到服务器端的 ACK ，认为服务器端已经正常关闭连接，于是自己也关闭连接，进入`CLOSED`状态。


## 参考

![TCP的三次握手与四次挥手](https://hit-alibaba.github.io/interview/basic/network/TCP.html)